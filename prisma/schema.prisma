generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPER_ADMIN
  HR_ADMIN
  MANAGER
  EMPLOYEE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(EMPLOYEE)
  isActive     Boolean  @default(true) @map("is_active")
  refreshToken String?  @map("refresh_token")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  employee           Employee?
  managedDepartments      Department[]       @relation("DepartmentManager")
  regularizedAttendances  AttendanceRecord[] @relation("AttendanceRegularizer")

  @@map("users")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  managerId   String?  @map("manager_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  manager   User?      @relation("DepartmentManager", fields: [managerId], references: [id])
  employees Employee[]

  @@map("departments")
}

model Designation {
  id          String   @id @default(cuid())
  title       String   @unique
  level       Int
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  employees Employee[]

  @@map("designations")
}

model Employee {
  id               String         @id @default(cuid())
  employeeCode     String         @unique @map("employee_code")
  userId           String         @unique @map("user_id")
  departmentId     String         @map("department_id")
  designationId    String         @map("designation_id")
  firstName        String         @map("first_name")
  lastName         String         @map("last_name")
  phone            String?
  encryptedAadhaar String?        @map("encrypted_aadhaar")
  encryptedPan     String?        @map("encrypted_pan")
  encryptedSalary  String?        @map("encrypted_salary")
  dateOfJoining    DateTime       @map("date_of_joining")
  dateOfLeaving    DateTime?      @map("date_of_leaving")
  status           EmployeeStatus @default(ACTIVE)
  managerId        String?        @map("manager_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  user          User        @relation(fields: [userId], references: [id])
  department    Department  @relation(fields: [departmentId], references: [id])
  designation   Designation @relation(fields: [designationId], references: [id])
  manager              Employee?            @relation("EmployeeHierarchy", fields: [managerId], references: [id])
  directReports        Employee[]           @relation("EmployeeHierarchy")
  attendanceRecords    AttendanceRecord[]
  attendanceSummaries  AttendanceSummary[]

  @@map("employees")
}

model AttendanceRecord {
  id              String           @id @default(cuid())
  employeeId      String           @map("employee_id")
  date            DateTime         @db.Date
  checkIn         DateTime         @map("check_in")
  checkOut        DateTime?        @map("check_out")
  checkInNote     String?          @map("check_in_note")
  checkOutNote    String?          @map("check_out_note")
  status          AttendanceStatus
  hoursWorked     Float?           @map("hours_worked")
  overtimeHours   Float?           @map("overtime_hours")
  isRegularized   Boolean          @default(false) @map("is_regularized")
  regularizedBy   String?          @map("regularized_by")
  regularizedAt   DateTime?        @map("regularized_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  employee    Employee @relation(fields: [employeeId], references: [id])
  regularizer User?    @relation("AttendanceRegularizer", fields: [regularizedBy], references: [id])

  @@unique([employeeId, date])
  @@index([date])
  @@map("attendance_records")
}

model AttendanceSummary {
  id                 String   @id @default(cuid())
  employeeId         String   @map("employee_id")
  month              Int
  year               Int
  totalPresent       Int      @default(0) @map("total_present")
  totalAbsent        Int      @default(0) @map("total_absent")
  totalHalfDays      Int      @default(0) @map("total_half_days")
  totalLate          Int      @default(0) @map("total_late")
  totalLeaves        Int      @default(0) @map("total_leaves")
  totalHolidays      Int      @default(0) @map("total_holidays")
  totalHoursWorked   Float    @default(0) @map("total_hours_worked")
  totalOvertimeHours Float    @default(0) @map("total_overtime_hours")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId, year, month])
  @@map("attendance_summaries")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}
