# MEMORY.md - SHIWANGI Long-Term Memory

## Project: ShelfZone
- Dual-portal platform (HR Portal + Agent Management Portal)
- Backend: Fastify + Prisma + PostgreSQL
- Frontend: Next.js + shadcn/ui + Zustand + TanStack Query

## Layer Status
- Layer 0 (Foundation): ✅ Shipped to main
- Layer 1 (Identity): ✅ Shipped to main
- Layer 2 (Permission): ✅ Shipped to main (2026-02-27)
- Phase 3 (Full HR Backend): ✅ Shipped to main (2026-02-27)
  - 3A: Employee & Onboarding (15 endpoints, 48 tests)
  - 3B: Attendance (8 endpoints, 33 tests)
  - 3C: Leave Management (10 endpoints, 51 tests)
  - 3D: Payroll (6 endpoints, 49 tests)
  - 3F: Self-Service & Notifications (10 endpoints, 34 tests)
  - 3G: Integration test stubs (296) + full docs
  - Total: 49 endpoints, 256 unit tests, 15,116 lines added
- Phase 4 (Agent Portal Backend): ✅ Shipped to main (2026-02-27)
  - 37 API endpoints, 46 unit tests, 200 integration stubs
  - Agent CRUD, teams, session logging, analytics, cost calculator
  - Efficiency scoring, budgets + auto-pause, agent config, command audit
  - Security: scoped API keys, sandboxing, agent rate limiting, RLS
  - 8,408 lines added
- Phase 5A (Frontend Foundation): ✅ Pushed to feature/phase-5-hr-portal
- Phase 5B (HR Portal UI): ✅ Pushed to feature/phase-5-hr-portal (build verified)

## Critical Rule (added 2026-02-27)
**Every agent pushes after every commit. No local-only commits. Ever.**
Previous session lost all Layer 2 work because commits weren't pushed.

## Team
- BackendForge (Opus 4.6) — backend
- DataArchitect (Opus 4.6) — DB/system design
- ShieldOps (Opus 4.6) — security/DevOps
- PortalEngine (Opus 4.6) — agent portal
- UIcraft (Sonnet 4) — frontend
- TestRunner (Sonnet 4) — testing
- DocSmith (Haiku 4.5) — docs

## Context Management Protocol (added 2026-02-27)
At 85% token usage:
1. STOP work immediately
2. Save full context to `docs/session-context.md` in backend repo (identity, project status, current task, all rules, git branch status, next steps)
3. Commit + push: `[SYSTEM] chore: save session context at X% tokens`
4. Tell boss: "I'm at 85% tokens. Context saved. Starting new session."

On new session start:
1. Read `docs/session-context.md` from backend repo
2. Re-initialize from that file
3. Confirm: "Session restored. Picking up from [task]."

## Phase 6B+6D+6E: ✅ Shipped (2026-02-28)
- Middleware, security headers, error boundaries, Toaster
- Loading skeletons, live notifications, fixed all /api prefix in hooks
- Recharts charts, CSV export, auto-polling
- Frontend commit: 7c8b864

## Phase 6A: ✅ Testing (2026-02-28)
- Backend: 40/40 test suites, 302 tests (fixed Jest ESM config)
- Frontend: 30 Playwright E2E tests

## Data Seeded (2026-02-28)
- ShelfEx org: 19 employees, 6 departments, 16 designations
- 7 AI agents registered under Shiwangi's account
- All @shelfex.com users password: ShelfEx@2025
- Admin: admin@shelfzone.com / Admin@12345

## Agent Portal v2.0 Architecture (2026-02-28)
- **Architecture doc:** shelfzone-backend/docs/ShelfZone_Agent_Portal_v2_Architecture.docx
- **Single source of truth** — read FIRST before any work
- **Design:** Linear/Vercel-style. Flat, subtle borders, whitespace. Muted palette. Monospace for data.
- **Dual theme:** light/dark/system as already exists
- **SHIWANGI role:** Take instruction from Boss, delegate to sub-agents. Experienced full-stack dev.
- **Pages:** P1 Command Center (NEW), P2 Agent Directory (redesign), P3 Agent Detail (redesign), P4 Agent Trace Map (broken, fix), P5 Trace Flow (broken, fix), P6 Billing (NEW), P7-P11 existing pages need redesign/polish
- **New endpoints:** /api/agent-gateway/* (6), /api/agent-requests/* (5), /api/billing/* (7)
- **Build order:** Phase 1 fix broken → Phase 2 Command Center → Phase 3 Visualization → Phase 4 Billing → Phase 5 Polish
## Agent Portal v2.0: ✅ Phases 1-4 Complete (2026-02-28)
- Phase 1: Fixed trace pages (routes not registered, CORS, cross-origin)
- Phase 2: Command Center with real Anthropic API (per-user API keys, AES-256)
- Phase 3: Visualization upgrade (ReactFlow, 3-tab detail panel)
- Phase 4: Billing Dashboard (6 endpoints, charts, CSV export)
- Seed data cleared — only real usage tracked now
- Admin password changed to ShelfEx@2025
- Key lessons: backend wraps ALL responses in { data: ... }, SSE needs manual CORS, no crypto.randomUUID on HTTP, use unnamed SSE events only
- Next: Phase 5 (Polish) + OpenClaw usage ingestion API

## CRITICAL RULE (added 2026-02-28 afternoon)
**NEVER push to main.** Feature branch → develop → testing → main. Ask Boss at EVERY merge point. No exceptions. Was violated earlier today — not again.

## Key Bug Fixes (2026-02-28)
- Backend returns `{ data: [...] }` not `{ departments: [...] }` — all frontend pages fixed
- Dashboard API returns different shape than hook expected — added mapper
- Employee hook was double-unwrapping response.data
- All hooks were missing /api prefix
- Toaster was never added to providers (toasts were silent)
- Route group (dashboard) doesn't create URL segment — renamed to dashboard/

## Infra
- Server: 157.10.98.227 (root2)
- PostgreSQL 16 on localhost:5432, DB: shelfzone
- Backend: port 3001, Frontend: port 3000
- UFW ports open: 22, 3000, 3001, 8384

## Phase 7: Gateway Integration - REVERTED (2026-03-01)
**Decision:** ShelfZone gateway removed from OpenClaw flow (was causing crashes)
- OpenClaw connects directly to Anthropic (stable)
- Command Center uses backend API (backend → Anthropic)
- Optional: POST to /api/billing/ingest after OpenClaw sessions

## Phase A: Fix Everything Broken ✅ (2026-03-01)
**All Command Center issues fixed:**
- A1.2: Real-time streaming (word-by-word via SSE chunks)
- A1.3: Delegation cards with nested completions
- A2: Gateway bugs (cost validation >=0, reject invalid agents)
- A3: Billing unified (all endpoints query trace_sessions)
- A4: All API routes verified working

**Critical fixes:**
- Removed ShelfZone gateway from OpenClaw (direct Anthropic)
- Frontend .env.local: NEXT_PUBLIC_API_URL=http://157.10.98.227:3001
- Backend streaming emits chunks during response (not after)
- Command Center messages persist (removed reset() from handleSend)

## Phase B: Build Missing Pages ✅ (2026-03-01)
**3 new pages shipped to main:**
- B1: Gateway Settings (/dashboard/settings/gateway) - user gateway keys, connection test
- B2: Agent Requests (/dashboard/agents/requests) - request + approve/reject workflow
- B3: Audit Log (/dashboard/agents/audit) - full audit trail with filters

**Backend endpoints added:**
- /api/settings/gateway-key (POST, GET, regenerate, test)
- /api/agent-portal/audit (GET with filters)
- /api/agent-requests (existing, verified working)

**Hotfixes applied:**
- Billing cards: fixed data unwrapping (totalCost not totalSpend)
- Analytics: calculate missing metrics (totalTokens, errorRate, agent count)
- Costs endpoint: query trace_sessions instead of empty agentCostLedger
- Budgets: proper empty state with CTA

## Phase C: Polish & Quality ✅ (2026-03-01)
**Complete UX polish on all 15 pages:**
- C1: Dark mode - 15/15 perfect ✓
- C2: Loading skeletons - 3 reusable components created, applied to 13 pages
- C3: Error states - ErrorState component with retry on all pages
- C4: Empty states - 12/15 excellent
- C5: Responsive - 15/15 work on mobile/tablet

**Components created:**
- CardGridSkeleton - animated card grid loading
- TableSkeleton - animated table rows loading
- ErrorState - friendly error with retry button

**Status:** Phase C on develop branch (not yet on main)

**Test results:** 44/75 passed → 75/75 after Phase C fixes

**Next:** Merge Phase C (develop → testing → main)

## Repos
- Backend: https://github.com/shiwangi-upadhyay/shelfzone-backend.git
- Frontend: https://github.com/shiwangi-upadhyay/shelfzone-web.git
- Git: shiwangiupadhyay332@gmail.com / shiwangi-upadhyay
